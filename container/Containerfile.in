/* 
BUILD BASE IMAGE

*/

FROM SOURCE_IMAGE as knotty-base

ARG TERM=xterm 
ARG DEBIAN_FRONTEND=noninteractive
#ifdef CI_SETX
ARG CI=1
#endif /* CI_SETX */

/* IMAGE_VERSION like 'knotty-pine-13-20250101''; generated by Justfile */
ARG IMAGE_VERSION=IMAGE_VERSION_SUB
/* Debian-friendly architecture shortname */
ARG ARCH=ARCH_SUB
/* Debian VERSION like '13'. Optionally given to `just build` as Second
argument. Available options from images.yml */
ARG VERSION=VERSION_SUB

/* Allow for colored output */
ARG TERM=xterm 
/* Run APT without input */
ARG DEBIAN_FRONTEND=noninteractive
/* Define CI argument if running in CI environment */
#ifdef CI_SETX
ARG CI=1
#endif /* CI_SETX */
/* Don't use SELinux features of OSTree */
ENV OSTREE_SELINUX_ENABLE=0

/* Run Bash recipe for package installations */
RUN --mount=type=cache,dst=/var/cache \
  --mount=type=tmpfs,dst=/var/log \
  --mount=type=tmpfs,dst=/var/tmp \
  --mount=type=tmpfs,dst=/tmp \
  bash <<'RUNEOF'
#include "build_files/packages"
RUNEOF

/* Run Bash recipe to configure operating system */
RUN --mount=type=cache,dst=/var/cache \
  --mount=type=tmpfs,dst=/var/log \
  --mount=type=tmpfs,dst=/var/tmp \
  --mount=type=tmpfs,dst=/tmp \
  bash <<'RUNEOF'
#include "build_files/system-configuration"
RUNEOF

/* Run Bash recipe to clean up unnecessary files and packages */
RUN --mount=type=cache,dst=/var/cache \
  --mount=type=tmpfs,dst=/var/log \
  --mount=type=tmpfs,dst=/var/tmp \
  --mount=type=tmpfs,dst=/tmp \
  bash <<'RUNEOF'
/* Remove unnecessary files/repositories/etc. */
#include "build_files/cleanup"
/* Remove packages and files not needed for specific version */
RUNEOF

/* Copy in cosign.pub key
COPY build_files/cosign.pub /run/build_files/cosign.pub

/* Run Bash recipe to finalize image
RUN bash <<'RUNEOF'
#include "build_files/finalize"
RUNEOF

/* Test BootC image */
RUN ["bootc", "container", "lint", "--fatal-warnings", "--no-truncate"]
RUN ["nbc", "lint", "--local"]

/* LABELS will be added by Justfile */
