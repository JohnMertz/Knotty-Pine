# /*
#shellcheck disable=SC2174,SC2114
# */

set ${CI:+-x} -euo pipefail

setterm --foreground green
echo "################"
echo "# Cleaning up..."
echo "################"
setterm --foreground default

setterm --foreground blue
echo "# Freeing /usr/local..."
setterm --foreground default

rm -rf /usr/local /usr/etc

setterm --foreground blue
echo "# Remove unneeded packages and APT archives..."
setterm --foreground default

apt-get autoremove -y --purge
apt-get clean -y
rm -rf /var/lib/dpkg/info /var/lib/apt
mkdir -p /var/lib/apt/lists

setterm --foreground blue
echo "# Remove unneeded files..."
setterm --foreground default

rm -rf \
  /etc/ssh/ssh_*_key* \
  /opt \
  /run \
  /var/backups \
  /var/cache/apt/archives \
  /var/lib/bind \
  /var/lib/clamav \
  /var/lib/dpkg/alternatives \
  /var/lib/dpkg/arch-native \
  /var/lib/dpkg/available \
  /var/lib/dpkg/cmethopt \
  /var/lib/dpkg/diversions \
  /var/lib/dpkg/diversions-old \
  /var/lib/dpkg/info \
  /var/lib/dpkg/lock \
  /var/lib/dpkg/lock-frontend \
  /var/lib/dpkg/parts \
  /var/lib/dpkg/status \
  /var/lib/dpkg/status-old \
  /var/lib/dpkg/statoverride-old \
  /var/lib/dpkg/statoverride \
  /var/lib/dpkg/triggers \
  /var/lib/dpkg/updates \
  /var/lib/extended_states \
  /var/lib/git \
  /var/lib/greylistd \
  /var/lib/grub \
  /var/lib/fail2ban \
  /var/lib/logrotate \
  /var/lib/mirrors/partial \
  /var/lib/mysql \
  /var/lib/ntpsec \
  /var/lib/os-prober \
  /var/lib/periodic \
  /var/lib/python \
  /var/lib/shells.state \
  /var/lib/sgml-base \
  /var/lib/ucf \
  /var/lib/vim \
  /var/lib/xml-core \
  /var/local \
  /var/mail \
  /var/spool/cron \
  /var/spool/mail \
  /var/spool/rsyslog \
  || true # If prohibited files fail to be deleted, the linter will find them

setterm --foreground blue
echo "# Adding approved /var directories..."
setterm --foreground default

for path in \
  /var/lib/dracut \
  /var/lib/flatpak \
  /var/lib/flatpak \
  /var/lib/ghostscript \
  /var/lib/libvirt \
  /var/lib/pam \
  /var/lib/plymouth \
  /var/lib/saned \
  /var/lib/snmp \
  /var/lib/systemd \
  /var/lib/tlp \
  /var/lib/xfonts \
  /var/spool/cups
do
  name=$(echo $path | sed 's/.*\///')
  for i in $(find $path -type d); do
    echo "d $i 0755 root root - -" >>/usr/lib/tmpfiles.d/$name.conf
  done
  for i in $(find $path -type f); do
    echo "f $i" >>/usr/lib/tmpfiles.d/$name.conf
  done
  for i in $(find $path -type l); do
    echo "L $i - - - - "$(stat --printf='%N' $i | cut -d "'" -f 4) >>/usr/lib/tmpfiles.d/$name.conf
  done
done


# /* systemd-timesyncd is removed during package install and extra user causes bootc lint error */
userdel systemd-timesync
